kind: job
metadata:
  name: train-sentiment-analysis
  tag: ''
  hash: 7342f7f2712547536f59005ee750b513467d9aac
  project: stocks
spec:
  command: ''
  args: []
  image: mlrun/ml-models-gpu
  env: []
  resources:
    limits:
      nvidia.com/gpu: 1
  default_handler: train_sentiment_analysis_model
  entry_points:
    forward:
      name: forward
      doc: ''
      parameters:
      - name: self
        default: ''
      - name: input_ids
        default: ''
      - name: attention_mask
        default: ''
      outputs:
      - default: ''
      lineno: 26
    score_to_sents:
      name: score_to_sents
      doc: ''
      parameters:
      - name: score
        default: ''
      outputs:
      - default: ''
      lineno: 61
    create_data_loader:
      name: create_data_loader
      doc: ''
      parameters:
      - name: df
        default: ''
      - name: tokenizer
        default: ''
      - name: max_len
        default: ''
      - name: batch_size
        default: ''
      outputs:
      - default: ''
      lineno: 68
    train_epoch:
      name: train_epoch
      doc: ''
      parameters:
      - name: model
        default: ''
      - name: data_loader
        default: ''
      - name: criterion
        default: ''
      - name: optimizer
        default: ''
      - name: scheduler
        default: ''
      - name: n_examples
        default: ''
      - name: device
        default: ''
      outputs:
      - default: ''
      lineno: 77
    eval_model:
      name: eval_model
      doc: ''
      parameters:
      - name: model
        default: ''
      - name: data_loader
        default: ''
      - name: criterion
        default: ''
      - name: n_examples
        default: ''
      - name: device
        default: ''
      outputs:
      - default: ''
      lineno: 115
    eval_on_test:
      name: eval_on_test
      doc: ''
      parameters:
      - name: model_path
        default: ''
      - name: data_loader
        default: ''
      - name: device
        default: ''
      - name: n_examples
        default: ''
      - name: pretrained_model
        default: ''
      - name: n_classes
        default: ''
      outputs:
      - default: ''
      lineno: 147
    train_sentiment_analysis_model:
      name: train_sentiment_analysis_model
      doc: ''
      parameters:
      - name: context
        type: MLClientCtx
        default: ''
      - name: reviews_dataset
        type: DataItem
        default: ''
      - name: pretrained_model
        type: str
        default: bert-base-cased
      - name: models_dir
        type: str
        default: models
      - name: model_filename
        type: str
        default: bert_sentiment_analysis_model.pt
      - name: n_classes
        type: int
        default: 3
      - name: MAX_LEN
        type: int
        default: 128
      - name: BATCH_SIZE
        type: int
        default: 16
      - name: EPOCHS
        type: int
        default: 50
      - name: random_state
        type: int
        default: 42
      outputs:
      - default: ''
      lineno: 172
  description: ''
  build:
    functionSourceCode: IyBHZW5lcmF0ZWQgYnkgbnVjbGlvLmV4cG9ydC5OdWNsaW9FeHBvcnRlcgoKaW1wb3J0IG9zCmltcG9ydCBwYW5kYXMgYXMgcGQKZnJvbSB0cmFuc2Zvcm1lcnMgaW1wb3J0IEJlcnRUb2tlbml6ZXIsIEFkYW1XLCBnZXRfbGluZWFyX3NjaGVkdWxlX3dpdGhfd2FybXVwLCBCZXJ0TW9kZWwKaW1wb3J0IHRvcmNoCmltcG9ydCB0b3JjaC5ubiBhcyBubgpmcm9tIHRvcmNoLnV0aWxzIGltcG9ydCBkYXRhCmltcG9ydCBtYXRwbG90bGliLnB5cGxvdCBhcyBwbHQKZnJvbSBza2xlYXJuLm1vZGVsX3NlbGVjdGlvbiBpbXBvcnQgdHJhaW5fdGVzdF9zcGxpdAppbXBvcnQgbnVtcHkgYXMgbnAKaW1wb3J0IHNlYWJvcm4gYXMgc25zCmZyb20gY29sbGVjdGlvbnMgaW1wb3J0IGRlZmF1bHRkaWN0CmZyb20gbWxydW4uYXJ0aWZhY3RzIGltcG9ydCBQbG90QXJ0aWZhY3QsIENoYXJ0QXJ0aWZhY3QsIFRhYmxlQXJ0aWZhY3QKZnJvbSBtbHJ1bi5kYXRhc3RvcmUgaW1wb3J0IERhdGFJdGVtCmZyb20gbWxydW4gaW1wb3J0IE1MQ2xpZW50Q3R4CgpjbGFzcyBCZXJ0U2VudGltZW50Q2xhc3NpZmllcihubi5Nb2R1bGUpOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIHByZXRyYWluZWRfbW9kZWwsIG5fY2xhc3Nlcyk6CiAgICAgICAgc3VwZXIoQmVydFNlbnRpbWVudENsYXNzaWZpZXIsIHNlbGYpLl9faW5pdF9fKCkKICAgICAgICBzZWxmLmJlcnQgPSBCZXJ0TW9kZWwuZnJvbV9wcmV0cmFpbmVkKHByZXRyYWluZWRfbW9kZWwpCiAgICAgICAgc2VsZi5kcm9wb3V0ID0gbm4uRHJvcG91dChwPTAuMikKICAgICAgICBzZWxmLm91dF9saW5lYXIgPSBubi5MaW5lYXIoc2VsZi5iZXJ0LmNvbmZpZy5oaWRkZW5fc2l6ZSwgbl9jbGFzc2VzKQogICAgICAgIHNlbGYuc29mdG1heCA9IG5uLlNvZnRtYXgoZGltPTEpCgogICAgZGVmIGZvcndhcmQoc2VsZiwgaW5wdXRfaWRzLCBhdHRlbnRpb25fbWFzayk6CiAgICAgICAgXywgcG9vbGVkX291dCA9IHNlbGYuYmVydCgKICAgICAgICAgICAgaW5wdXRfaWRzPWlucHV0X2lkcywKICAgICAgICAgICAgYXR0ZW50aW9uX21hc2s9YXR0ZW50aW9uX21hc2sKICAgICAgICApCiAgICAgICAgb3V0ID0gc2VsZi5kcm9wb3V0KHBvb2xlZF9vdXQpCiAgICAgICAgb3V0ID0gc2VsZi5vdXRfbGluZWFyKG91dCkKICAgICAgICByZXR1cm4gc2VsZi5zb2Z0bWF4KG91dCkKCmNsYXNzIFJldmlld3NEYXRhc2V0KGRhdGEuRGF0YXNldCk6CiAgICBkZWYgX19pbml0X18oc2VsZiwgcmV2aWV3LCB0YXJnZXQsIHRva2VuaXplciwgbWF4X2xlbik6CiAgICAgICAgc2VsZi5yZXZpZXcgPSByZXZpZXcKICAgICAgICBzZWxmLnRhcmdldCA9IHRhcmdldAogICAgICAgIHNlbGYudG9rZW5pemVyID0gdG9rZW5pemVyCiAgICAgICAgc2VsZi5tYXhfbGVuID0gbWF4X2xlbgogICAgCiAgICBkZWYgX19sZW5fXyhzZWxmKToKICAgICAgICByZXR1cm4gbGVuKHNlbGYucmV2aWV3KQogICAgCiAgICBkZWYgX19nZXRpdGVtX18oc2VsZiwgaXRlbSk6CiAgICAgICAgcmV2aWV3ID0gc3RyKHNlbGYucmV2aWV3W2l0ZW1dKQogICAgICAgIGVuYyA9IHNlbGYudG9rZW5pemVyLmVuY29kZV9wbHVzKAogICAgICAgICAgICByZXZpZXcsCiAgICAgICAgICAgIG1heF9sZW5ndGg9c2VsZi5tYXhfbGVuLAogICAgICAgICAgICBhZGRfc3BlY2lhbF90b2tlbnM9VHJ1ZSwKICAgICAgICAgICAgcGFkX3RvX21heF9sZW5ndGg9VHJ1ZSwKICAgICAgICAgICAgcmV0dXJuX2F0dGVudGlvbl9tYXNrPVRydWUsCiAgICAgICAgICAgIHJldHVybl90b2tlbl90eXBlX2lkcz1GYWxzZSwKICAgICAgICAgICAgcmV0dXJuX3RlbnNvcnM9J3B0JywKICAgICAgICAgICAgdHJ1bmNhdGlvbj1UcnVlKQogICAgICAgIAogICAgICAgIHJldHVybiB7J2lucHV0X2lkcyc6IGVuY1snaW5wdXRfaWRzJ10uc3F1ZWV6ZSgwKSwgCiAgICAgICAgICAgICAgICAnYXR0ZW50aW9uX21hc2snOiBlbmNbJ2F0dGVudGlvbl9tYXNrJ10uc3F1ZWV6ZSgwKSwKICAgICAgICAgICAgICAgICd0YXJnZXRzJzogdG9yY2gudGVuc29yKHNlbGYudGFyZ2V0W2l0ZW1dLCBkdHlwZT10b3JjaC5sb25nKX0KCmRlZiBzY29yZV90b19zZW50cyhzY29yZSk6CiAgICBpZiBzY29yZSA8PSAyOgogICAgICAgIHJldHVybiAwCiAgICBpZiBzY29yZSA9PSAzOgogICAgICAgIHJldHVybiAxCiAgICByZXR1cm4gMgoKZGVmIGNyZWF0ZV9kYXRhX2xvYWRlcihkZiwgdG9rZW5pemVyLCBtYXhfbGVuLCBiYXRjaF9zaXplKToKICAgIGRhdGFzZXQgPSBSZXZpZXdzRGF0YXNldCgKICAgICAgICByZXZpZXc9ZGYuY29udGVudC50b19udW1weSgpLAogICAgICAgIHRhcmdldD1kZi5zZW50aW1lbnQudG9fbnVtcHkoKSwKICAgICAgICB0b2tlbml6ZXI9dG9rZW5pemVyLAogICAgICAgIG1heF9sZW49bWF4X2xlbikKICAgIAogICAgcmV0dXJuIGRhdGEuRGF0YUxvYWRlcihkYXRhc2V0LCBiYXRjaF9zaXplPWJhdGNoX3NpemUsIG51bV93b3JrZXJzPTQpCgpkZWYgdHJhaW5fZXBvY2goCiAgICBtb2RlbCwKICAgIGRhdGFfbG9hZGVyLAogICAgY3JpdGVyaW9uLAogICAgb3B0aW1pemVyLAogICAgc2NoZWR1bGVyLAogICAgbl9leGFtcGxlcywKICAgIGRldmljZQopOgogICAgbW9kZWwudHJhaW4oKQogICAgbG9zc2VzID0gW10KICAgIGNvcnJlY3RfcHJlZHMgPSAwCiAgICAKICAgIGZvciBpLCBkIGluIGVudW1lcmF0ZShkYXRhX2xvYWRlcik6CiAgICAgICAgaWYgaSAlIDUwID09IDA6CiAgICAgICAgICAgIHByaW50KGYnYmF0Y2gge2kgKyAxfS8ge2xlbihkYXRhX2xvYWRlcil9JykKICAgICAgICBpbnB1dF9pZHMgPSBkWydpbnB1dF9pZHMnXS50byhkZXZpY2UpCiAgICAgICAgYXR0ZW50aW9uX21hc2sgPSBkWydhdHRlbnRpb25fbWFzayddLnRvKGRldmljZSkKICAgICAgICB0YXJnZXRzID0gZFsndGFyZ2V0cyddLnRvKGRldmljZSkKICAgICAgICAKICAgICAgICBvdXRwdXRzID0gbW9kZWwoCiAgICAgICAgICAgIGlucHV0X2lkcz1pbnB1dF9pZHMsCiAgICAgICAgICAgIGF0dGVudGlvbl9tYXNrPWF0dGVudGlvbl9tYXNrCiAgICAgICAgKQogICAgICAgIAogICAgICAgIF8sIHByZWQgPSB0b3JjaC5tYXgob3V0cHV0cywgZGltPTEpCiAgICAgICAgCiAgICAgICAgbG9zcyA9IGNyaXRlcmlvbihvdXRwdXRzLCB0YXJnZXRzKQogICAgICAgIGNvcnJlY3RfcHJlZHMgKz0gdG9yY2guc3VtKHByZWQgPT0gdGFyZ2V0cykKICAgICAgICBsb3NzZXMuYXBwZW5kKGxvc3MuaXRlbSgpKQogICAgICAgIAogICAgICAgIGxvc3MuYmFja3dhcmQoKQogICAgICAgIG5uLnV0aWxzLmNsaXBfZ3JhZF9ub3JtXyhtb2RlbC5wYXJhbWV0ZXJzKCksIG1heF9ub3JtPTEuMCkKICAgICAgICBvcHRpbWl6ZXIuc3RlcCgpCiAgICAgICAgc2NoZWR1bGVyLnN0ZXAoKQogICAgICAgIG9wdGltaXplci56ZXJvX2dyYWQoKQogICAgcmV0dXJuIChjb3JyZWN0X3ByZWRzLmRvdWJsZSgpIC8gbl9leGFtcGxlcykuZGV0YWNoKCkuY3B1KCkubnVtcHkoKSwgbnAubWVhbihsb3NzZXMpCgpkZWYgZXZhbF9tb2RlbCgKICAgIG1vZGVsLAogICAgZGF0YV9sb2FkZXIsCiAgICBjcml0ZXJpb24sCiAgICBuX2V4YW1wbGVzLAogICAgZGV2aWNlCik6CiAgICBwcmludCgnZXZhbHVhdGlvbicpCiAgICBtb2RlbCA9IG1vZGVsLmV2YWwoKQogICAgY29ycmVjdF9wcmVkcyA9IDAKICAgIGxvc3NlcyA9IFtdCiAgICAKICAgIHdpdGggdG9yY2gubm9fZ3JhZCgpOgogICAgICAgIGZvciBpLCBkIGluIGVudW1lcmF0ZShkYXRhX2xvYWRlcik6CiAgICAgICAgICAgIGlmIGkgJSA1MCA9PSAwOgogICAgICAgICAgICAgICAgcHJpbnQoZidiYXRjaCB7aSArIDF9LyB7bGVuKGRhdGFfbG9hZGVyKX0nKQogICAgICAgICAgICBpbnB1dF9pZHMgPSBkWydpbnB1dF9pZHMnXS50byhkZXZpY2UpCiAgICAgICAgICAgIGF0dGVudGlvbl9tYXNrID0gZFsnYXR0ZW50aW9uX21hc2snXS50byhkZXZpY2UpCiAgICAgICAgICAgIHRhcmdldHMgPSBkWyd0YXJnZXRzJ10udG8oZGV2aWNlKQogICAgICAgICAgICAKICAgICAgICAgICAgb3V0cHV0cyA9IG1vZGVsKAogICAgICAgICAgICAgICAgaW5wdXRfaWRzPWlucHV0X2lkcywKICAgICAgICAgICAgICAgIGF0dGVudGlvbl9tYXNrPWF0dGVudGlvbl9tYXNrCiAgICAgICAgICAgICkKICAgICAgICAgICAgCiAgICAgICAgICAgIF8sIHByZWQgPSB0b3JjaC5tYXgob3V0cHV0cywgZGltPTEpCgogICAgICAgICAgICBsb3NzID0gY3JpdGVyaW9uKG91dHB1dHMsIHRhcmdldHMpCiAgICAgICAgICAgIGNvcnJlY3RfcHJlZHMgKz0gdG9yY2guc3VtKHByZWQgPT0gdGFyZ2V0cykKICAgICAgICAgICAgbG9zc2VzLmFwcGVuZChsb3NzLml0ZW0oKSkKICAgIHJldHVybiAoY29ycmVjdF9wcmVkcy5kb3VibGUoKSAvIG5fZXhhbXBsZXMpLmRldGFjaCgpLmNwdSgpLm51bXB5KCksIG5wLm1lYW4obG9zc2VzKQoKZGVmIGV2YWxfb25fdGVzdChtb2RlbF9wYXRoLCBkYXRhX2xvYWRlciwgZGV2aWNlLCBuX2V4YW1wbGVzLCBwcmV0cmFpbmVkX21vZGVsLCBuX2NsYXNzZXMpOgogICAgbW9kZWwgPSBCZXJ0U2VudGltZW50Q2xhc3NpZmllcihwcmV0cmFpbmVkX21vZGVsLCBuX2NsYXNzZXMpLnRvKGRldmljZSkKICAgIG1vZGVsLmxvYWRfc3RhdGVfZGljdCh0b3JjaC5sb2FkKG1vZGVsX3BhdGgpKQogICAgbW9kZWwuZXZhbCgpCgogICAgY29ycmVjdF9wcmVkcyA9IDAKCiAgICB3aXRoIHRvcmNoLm5vX2dyYWQoKToKICAgICAgICBmb3IgaSwgZCBpbiBlbnVtZXJhdGUoZGF0YV9sb2FkZXIpOgogICAgICAgICAgICBpZiBpICUgNTAgPT0gMDoKICAgICAgICAgICAgICAgIHByaW50KGYnYmF0Y2gge2kgKyAxfS8ge2xlbihkYXRhX2xvYWRlcil9JykKCiAgICAgICAgICAgIGlucHV0X2lkcyA9IGRbJ2lucHV0X2lkcyddLnRvKGRldmljZSkKICAgICAgICAgICAgYXR0ZW50aW9uX21hc2sgPSBkWydhdHRlbnRpb25fbWFzayddLnRvKGRldmljZSkKICAgICAgICAgICAgdGFyZ2V0cyA9IGRbJ3RhcmdldHMnXS50byhkZXZpY2UpCgogICAgICAgICAgICBvdXRwdXRzID0gbW9kZWwoCiAgICAgICAgICAgICAgICBpbnB1dF9pZHM9aW5wdXRfaWRzLAogICAgICAgICAgICAgICAgYXR0ZW50aW9uX21hc2s9YXR0ZW50aW9uX21hc2sKICAgICAgICAgICAgKQoKICAgICAgICAgICAgXywgcHJlZCA9IHRvcmNoLm1heChvdXRwdXRzLCBkaW09MSkKICAgICAgICAgICAgY29ycmVjdF9wcmVkcyArPSB0b3JjaC5zdW0ocHJlZCA9PSB0YXJnZXRzKQogICAgcmV0dXJuIGNvcnJlY3RfcHJlZHMuZG91YmxlKCkgLyBuX2V4YW1wbGVzCgpkZWYgdHJhaW5fc2VudGltZW50X2FuYWx5c2lzX21vZGVsKGNvbnRleHQ6IE1MQ2xpZW50Q3R4LCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXZpZXdzX2RhdGFzZXQ6IERhdGFJdGVtLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZXRyYWluZWRfbW9kZWw6IHN0ciA9ICdiZXJ0LWJhc2UtY2FzZWQnLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb2RlbHNfZGlyOiBzdHIgPSAnbW9kZWxzJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb2RlbF9maWxlbmFtZTogc3RyID0gJ2JlcnRfc2VudGltZW50X2FuYWx5c2lzX21vZGVsLnB0JywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuX2NsYXNzZXM6IGludCA9IDMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTUFYX0xFTjogaW50ID0gMTI4LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEJBVENIX1NJWkU6IGludCA9IDE2LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEVQT0NIUzogaW50ID0gNTAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFuZG9tX3N0YXRlOiBpbnQgPSA0Mik6CgogICAgZGV2aWNlID0gdG9yY2guZGV2aWNlKCdjdWRhOjAnKSBpZiB0b3JjaC5jdWRhLmlzX2F2YWlsYWJsZSgpIGVsc2UgdG9yY2guZGV2aWNlKCdjcHUnKQogICAgYmFzZV9wYXRoID0gb3MucGF0aC5hYnNwYXRoKGNvbnRleHQuYXJ0aWZhY3RfcGF0aCkKICAgIHBsb3RzX3BhdGggPSBvcy5wYXRoLmpvaW4oYmFzZV9wYXRoLCAncGxvdHMnKQogICAgZGF0YV9wYXRoID0gb3MucGF0aC5qb2luKGJhc2VfcGF0aCwgJ2RhdGEnKQogICAgY29udGV4dC5sb2dnZXIuaW5mbyhmJ1VzaW5nIHtkZXZpY2V9JykKICAgIAogICAgbW9kZWxzX2Jhc2VwYXRoID0gb3MucGF0aC5qb2luKGNvbnRleHQuYXJ0aWZhY3RfcGF0aCwgbW9kZWxzX2RpcikKICAgIG9zLm1ha2VkaXJzKG1vZGVsc19iYXNlcGF0aCwgZXhpc3Rfb2s9VHJ1ZSkKICAgIG1vZGVsX2ZpbGVwYXRoID0gb3MucGF0aC5qb2luKG1vZGVsc19iYXNlcGF0aCwgbW9kZWxfZmlsZW5hbWUpCiAgICAKICAgIGRmID0gcmV2aWV3c19kYXRhc2V0LmFzX2RmKCkKICAgIAogICAgZGYgPSBkZltbJ2NvbnRlbnQnLCAnc2NvcmUnXV0KICAgIHNucy5kaXN0cGxvdChkZi5zY29yZSkKICAgIHJldmlld3Nfc2NvcmVzX2FydGlmYWN0ID0gY29udGV4dC5sb2dfYXJ0aWZhY3QoUGxvdEFydGlmYWN0KGYicmV2aWV3cy1zY29yZXMiLCBib2R5PXBsdC5nY2YoKSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldF9wYXRoPWYie3Bsb3RzX3BhdGh9L3Jldmlld3Mtc2NvcmVzLmh0bWwiKQogICAgCiAgICBkZlsnc2VudGltZW50J10gPSBkZlsnc2NvcmUnXS5hcHBseShzY29yZV90b19zZW50cykKICAgIAogICAgdG9rZW5pemVyID0gQmVydFRva2VuaXplci5mcm9tX3ByZXRyYWluZWQocHJldHJhaW5lZF9tb2RlbCkKICAgIAogICAgbGVucyA9IFtsZW4odG9rZW5pemVyLmVuY29kZShkZi5sb2NbcmV2aWV3XVsnY29udGVudCddKSkgZm9yIHJldmlldyBpbiBkZi5pbmRleF0KICAgIG1heF9sZW5ndGggPSBtYXgobGVucykKICAgIGNvbnRleHQubG9nZ2VyLmluZm8oZidsb25nZXN0IHJldmlldzoge21heF9sZW5ndGh9JykKICAgIHBsdC5jbGYoKQogICAgc25zLmRpc3RwbG90KGxlbnMpCiAgICByZXZpZXdzX2xlbmd0aHNfYXJ0aWZhY3QgPSBjb250ZXh0LmxvZ19hcnRpZmFjdChQbG90QXJ0aWZhY3QoZiJyZXZpZXdzLWxlbmd0aHMiLCBib2R5PXBsdC5nY2YoKSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXRfcGF0aD1mIntwbG90c19wYXRofS9yZXZpZXdzLWxlbmd0aHMuaHRtbCIpCiAgICAKICAgIGRmX3RyYWluLCBkZl90ZXN0ID0gdHJhaW5fdGVzdF9zcGxpdChkZiwgdGVzdF9zaXplPTAuMiwgcmFuZG9tX3N0YXRlPXJhbmRvbV9zdGF0ZSkKICAgIGRmX2RldiwgZGZfdGVzdCA9IHRyYWluX3Rlc3Rfc3BsaXQoZGZfdGVzdCwgdGVzdF9zaXplID0gMC41LCByYW5kb21fc3RhdGU9cmFuZG9tX3N0YXRlKQogICAgCiAgICB0cmFpbl9sb2FkZXIgPSBjcmVhdGVfZGF0YV9sb2FkZXIoZGZfdHJhaW4sIHRva2VuaXplciwgTUFYX0xFTiwgQkFUQ0hfU0laRSkKICAgIGRldl9sb2FkZXIgPSBjcmVhdGVfZGF0YV9sb2FkZXIoZGZfZGV2LCB0b2tlbml6ZXIsIE1BWF9MRU4sIEJBVENIX1NJWkUpCiAgICB0ZXN0X2xvYWRlciA9IGNyZWF0ZV9kYXRhX2xvYWRlcihkZl90ZXN0LCB0b2tlbml6ZXIsIE1BWF9MRU4sIEJBVENIX1NJWkUpCiAgICAKICAgIG1vZGVsID0gQmVydFNlbnRpbWVudENsYXNzaWZpZXIocHJldHJhaW5lZF9tb2RlbCwgbl9jbGFzc2VzPW5fY2xhc3NlcykudG8oZGV2aWNlKQogICAgCiAgICBvcHRpbWl6ZXIgPSBBZGFtVyhtb2RlbC5wYXJhbWV0ZXJzKCksIGxyPTJlLTUsIGNvcnJlY3RfYmlhcz1GYWxzZSkKICAgIHRvdGFsX3N0ZXBzID0gbGVuKHRyYWluX2xvYWRlcikgKiBFUE9DSFMKICAgIHNjaGVkdWxlciA9IGdldF9saW5lYXJfc2NoZWR1bGVfd2l0aF93YXJtdXAob3B0aW1pemVyPW9wdGltaXplciwgbnVtX3dhcm11cF9zdGVwcz0wLCBudW1fdHJhaW5pbmdfc3RlcHM9dG90YWxfc3RlcHMpCiAgICBjcml0ZXJpb24gPSBubi5Dcm9zc0VudHJvcHlMb3NzKCkudG8oZGV2aWNlKQogICAgCiAgICBoaXN0b3J5ID0gZGVmYXVsdGRpY3QobGlzdCkKICAgIGJlc3RfYWNjID0gMAoKICAgIGNvbnRleHQubG9nZ2VyLmluZm8oJ1N0YXJ0ZWQgdHJhaW5pbmcgdGhlIG1vZGVsJykKICAgIGZvciBlcG9jaCBpbiByYW5nZShFUE9DSFMpOgogICAgICAgIHRyYWluX2FjYywgdHJhaW5fbG9zcyA9IHRyYWluX2Vwb2NoKAogICAgICAgICAgICBtb2RlbCwKICAgICAgICAgICAgdHJhaW5fbG9hZGVyLAogICAgICAgICAgICBjcml0ZXJpb24sCiAgICAgICAgICAgIG9wdGltaXplciwKICAgICAgICAgICAgc2NoZWR1bGVyLAogICAgICAgICAgICBsZW4oZGZfdHJhaW4pLAogICAgICAgICAgICBkZXZpY2UKICAgICAgICApCiAgICAgICAgCiAgICAgICAgZGV2X2FjYywgZGV2X2xvc3MgPSBldmFsX21vZGVsKAogICAgICAgICAgICBtb2RlbCwKICAgICAgICAgICAgZGV2X2xvYWRlciwKICAgICAgICAgICAgY3JpdGVyaW9uLAogICAgICAgICAgICBsZW4oZGZfZGV2KSwKICAgICAgICAgICAgZGV2aWNlCiAgICAgICAgKQoKICAgICAgICBoaXN0b3J5Wyd0cmFpbl9hY2MnXS5hcHBlbmQodHJhaW5fYWNjKQogICAgICAgIGhpc3RvcnlbJ3RyYWluX2xvc3MnXS5hcHBlbmQodHJhaW5fbG9zcykKICAgICAgICBoaXN0b3J5WydkZXZfYWNjJ10uYXBwZW5kKGRldl9hY2MpCiAgICAgICAgaGlzdG9yeVsnZGV2X2xvc3MnXS5hcHBlbmQoZGV2X2xvc3MpCiAgICAgICAgY29udGV4dC5sb2dnZXIuaW5mbyhmJ0Vwb2NoOiB7ZXBvY2ggKyAxfS97RVBPQ0hTfTogVHJhaW4gbG9zczoge3RyYWluX2xvc3N9LCBhY2N1cmFjeToge3RyYWluX2FjY30gVmFsIGxvc3M6IHtkZXZfbG9zc30sIGFjY3VyYWN5OiB7ZGV2X2FjY30nKQoKICAgICAgICBpZiBkZXZfYWNjID4gYmVzdF9hY2M6CiAgICAgICAgICAgIHRvcmNoLnNhdmUobW9kZWwuc3RhdGVfZGljdCgpLCBtb2RlbF9maWxlcGF0aCkKICAgICAgICAgICAgY29udGV4dC5sb2dnZXIuaW5mbyhmJ1VwZGF0aW5nIG1vZGVsLCBDdXJyZW50IG1vZGVscyBpcyBiZXR0ZXIgdGhlbiB0aGUgcHJldmlvdXMgb25lICh7YmVzdF9hY2N9IHZzLiB7ZGV2X2FjY30pLicpCiAgICAgICAgICAgIGJlc3RfYWNjID0gZGV2X2FjYwogICAgICAgIGNoYXJ0ID0gQ2hhcnRBcnRpZmFjdCgnc3VtbWFyeScpCiAgICAgICAgY2hhcnQuaGVhZGVyID0gWydlcG9jaCcsICdhY2N1cmFjeScsICd2YWxfYWNjdXJhY3knLCAnbG9zcycsICd2YWxfbG9zcyddCiAgICAgICAgZm9yIGkgaW4gcmFuZ2UoRVBPQ0hTKToKICAgICAgICAgICAgY2hhcnQuYWRkX3JvdyhbaSArIDEsIGhpc3RvcnlbJ3RyYWluX2FjYyddW2ldLAogICAgICAgICAgICAgICAgICAgICAgICAgICBoaXN0b3J5Wyd0cmFpbl9sb3NzJ11baV0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgIGhpc3RvcnlbJ2Rldl9hY2MnXVtpXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgaGlzdG9yeVsnZGV2X2xvc3MnXVtpXV0pCiAgICAgICAgc3VtbWFyeSA9IGNvbnRleHQubG9nX2FydGlmYWN0KGNoYXJ0LCBsb2NhbF9wYXRoPW9zLnBhdGguam9pbigncGxvdHMnLCAnc3VtbWFyeS5odG1sJykpCiAgICAgICAgCiAgICAgICAgaGlzdG9yeV9kZiA9IHBkLkRhdGFGcmFtZShoaXN0b3J5KQogICAgICAgIGhpc3RvcnlfdGFibGUgPSBUYWJsZUFydGlmYWN0KCdoaXN0b3J5JywgZGY9aGlzdG9yeV9kZikKICAgICAgICBoaXN0b3J5X2FydGlmYWN0ID0gY29udGV4dC5sb2dfYXJ0aWZhY3QoaGlzdG9yeV90YWJsZSwgdGFyZ2V0X3BhdGg9b3MucGF0aC5qb2luKGRhdGFfcGF0aCwgJ2hpc3RvcnkuY3N2JykpCiAgICAgICAgCiAgICAgICAgdGVzdF9hY2MgPSBldmFsX29uX3Rlc3QobW9kZWxfZmlsZXBhdGgsIHRlc3RfbG9hZGVyLCBkZXZpY2UsIGxlbihkZl90ZXN0KSwgcHJldHJhaW5lZF9tb2RlbCwgbl9jbGFzc2VzKQogICAgICAgIGNvbnRleHQubG9nZ2VyLmluZm8oZidSZWNlaXZlZCB7dGVzdF9hY2N9IG9uIHRlc3QgZGF0YXNldCcpCiAgICAgICAgcmVzdWx0cyA9IHsndHJhaW5fYWNjdXJhY3knOiB0cmFpbl9hY2MsCiAgICAgICAgICAgICAgICAgICAndHJhaW5fbG9zcyc6IHRyYWluX2xvc3MsCiAgICAgICAgICAgICAgICAgICAnYmVzdF9hY2NjdXJhY3knOiBiZXN0X2FjYywKICAgICAgICAgICAgICAgICAgICd2YWxpZGF0aW9uX2FjY3VyYWN5JzogZGV2X2FjYywKICAgICAgICAgICAgICAgICAgICd2YWxpZGF0aW9uX2xvc3MnOiBkZXZfbG9zc30KICAgICAgICBjb250ZXh0LmxvZ19yZXN1bHRzKHJlc3VsdHMpCiAgICAgICAgY29udGV4dC5sb2dfbW9kZWwoa2V5PSdiZXJ0X3NlbnRpbWVudF9hbmFseXNpc19tb2RlbCcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kZWxfZmlsZT1tb2RlbF9maWxlbmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgICBtb2RlbF9kaXI9bW9kZWxzX2RpciwKICAgICAgICAgICAgICAgICAgICAgICAgICBhcnRpZmFjdF9wYXRoPWNvbnRleHQuYXJ0aWZhY3RfcGF0aCwKICAgICAgICAgICAgICAgICAgICAgICAgICB1cGxvYWQ9RmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWxzPXsnZnJhbWV3b3JrJzogJ3B5dG9yY2gnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2NhdGVnb3J5JzogJ25scCcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnYWN0aW9uJzogJ3NlbnRpbWVudF9hbmFseXNpcyd9LAogICAgICAgICAgICAgICAgICAgICAgICAgIG1ldHJpY3M9Y29udGV4dC5yZXN1bHRzLAogICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmFtZXRlcnM9eydwcmV0cmFpbmVkX21vZGVsJzogcHJldHJhaW5lZF9tb2RlbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnTUFYX0xFTic6IE1BWF9MRU4sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ0JBVENIX1NJWkUnOiBCQVRDSF9TSVpFLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdFUE9DSFMnOiBFUE9DSFMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3JhbmRvbV9zdGF0ZSc6IHJhbmRvbV9zdGF0ZX0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgZXh0cmFfZGF0YT17J3Jldmlld3Nfc2NvcmVzJzogcmV2aWV3c19zY29yZXNfYXJ0aWZhY3QsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3Jldmlld3NfbGVuZ3RoJzogcmV2aWV3c19sZW5ndGhzX2FydGlmYWN0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd0cmFpbmluZ19oaXN0b3J5JzogaGlzdG9yeV9hcnRpZmFjdH0pCiAgICAKCg==
    commands:
    - python -m pip install transformers==3.0.1 torch
    code_origin: https://github.com/mlrun/demo-stocks#54a200e6bae00b5326962ff38745046541d84bfc:train_sentiment_analysis.ipynb
